name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.0.0)"
        required: true
      chrome_extension_id:
        description: "Chrome/Edge Extension ID (optional, defaults to placeholder)"
        required: false
        default: "EXTENSION_ID_PLACEHOLDER"
      next_dev_version:
        description: "Next development version (e.g., 1.0.1-SNAPSHOT). Leave empty to auto-increment."
        required: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Use PAT_TOKEN instead of GITHUB_TOKEN to allow pushing commits and tags that trigger workflows
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          java-version: "23"
          distribution: "temurin"

      - name: Calculate next development version
        id: next_version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          NEXT_DEV_VERSION="${{ github.event.inputs.next_dev_version }}"

          # Calculate next dev version if not provided
          if [[ -z "$NEXT_DEV_VERSION" ]]; then
            IFS='.' read -ra VERSION_PARTS <<< "$VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}
            NEXT_PATCH=$((PATCH + 1))
            NEXT_DEV_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-SNAPSHOT"
          fi

          echo "next_dev_version=$NEXT_DEV_VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          echo "Next development version: $NEXT_DEV_VERSION"

      - name: Update Maven version
        run: |
          cd nfc-reader-host
          mvn versions:set -DnewVersion=${{ github.event.inputs.version }} -DgenerateBackupPoms=false

      - name: Update browser extension version
        run: |
          cd browser-extension
          VERSION=${{ github.event.inputs.version }}
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" manifest.json

      - name: Configure Chrome extension ID in scripts
        run: |
          CHROME_EXT_ID="${{ github.event.inputs.chrome_extension_id }}"

          # Linux
          sed -i "s/CHROME_EXTENSION_ID:-EXTENSION_ID_PLACEHOLDER/CHROME_EXTENSION_ID:-$CHROME_EXT_ID/g" \
            nfc-reader-host/src/main/resources/linux/postinstall.sh

          # macOS
          sed -i "s/CHROME_EXTENSION_ID:-EXTENSION_ID_PLACEHOLDER/CHROME_EXTENSION_ID:-$CHROME_EXT_ID/g" \
            nfc-reader-host/src/main/resources/macos/postinstall.sh

          # Windows
          sed -i "s/CHROME_EXTENSION_ID:-EXTENSION_ID_PLACEHOLDER/CHROME_EXTENSION_ID:-$CHROME_EXT_ID/g" \
            nfc-reader-host/src/main/resources/windows/postinstall.bat

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit release version
        run: |
          git add nfc-reader-host/pom.xml browser-extension/manifest.json
          git add nfc-reader-host/src/main/resources/*/postinstall.*
          git commit -m "Release version ${{ github.event.inputs.version }}"
          git push origin main

      - name: Create and push release tag
        run: |
          git tag -a "v${{ github.event.inputs.version }}" -m "Release v${{ github.event.inputs.version }}"
          git push origin "v${{ github.event.inputs.version }}"

      - name: Update to next development version
        run: |
          cd nfc-reader-host
          mvn versions:set -DnewVersion=${{ steps.next_version.outputs.next_dev_version }} -DgenerateBackupPoms=false

      - name: Update browser extension to next development version
        run: |
          cd browser-extension
          VERSION=${{ steps.next_version.outputs.next_dev_version }}
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" manifest.json

      - name: Commit next development version
        run: |
          git add nfc-reader-host/pom.xml browser-extension/manifest.json
          git commit -m "Prepare next development version ${{ steps.next_version.outputs.next_dev_version }}"
          git push origin main

      - name: Summary
        run: |
          echo "‚úÖ Release preparation complete!"
          echo "üì¶ Released version: ${{ github.event.inputs.version }}"
          echo "üè∑Ô∏è  Tag created: v${{ github.event.inputs.version }}"
          echo "üîÑ Next development version: ${{ steps.next_version.outputs.next_dev_version }}"
          echo ""
          echo "The release workflow will now be triggered automatically by the tag push."
